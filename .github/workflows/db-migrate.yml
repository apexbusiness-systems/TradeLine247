name: migrate

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/migrations/**'
  workflow_dispatch: # Allow manual trigger

jobs:
  migrate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      # CRITICAL FIX: Create temp directory BEFORE running CLI
      - name: Prepare Supabase Environment
        run: |
          mkdir -p supabase/.temp
          touch supabase/.temp/profile
          echo "âœ… Environment prepared"

      # CRITICAL FIX: Use direct database connection (no CLI linking)
      - name: Run Migrations (Direct Connection)
        run: |
          echo "ðŸš€ Starting migration to remote database..."

          # Use existing secret name
          DB_URL="${{ secrets.SUPABASE_DB_URL }}"

          echo "Connecting to Supabase database..."

          # Apply migrations directly with connection string
          supabase db push --db-url "$DB_URL" --include-all

          echo "âœ… Migrations applied successfully"
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

      # Verify migrations were applied
      - name: Verify Migration Status
        run: |
          DB_URL="${{ secrets.SUPABASE_DB_URL }}"

          # List applied migrations
          supabase migration list --db-url "$DB_URL"

          echo "âœ… Migration verification complete"
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
