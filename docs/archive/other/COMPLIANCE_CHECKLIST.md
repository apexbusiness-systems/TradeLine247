# DRIFT-05: Compliance Guardrails (Canada-First)

## CASL (Canadian Anti-Spam Legislation)

### ✅ Every Commercial Electronic Message (CEM) Must Have:

1. **Consent Basis** (tracked in `campaign_members.consent_basis`):
   - `express`: Checkbox opt-in, form submission with consent language
   - `implied_ebr`: Existing business relationship (within 24 months of last transaction)
   - `implied_published`: Publicly available contact info (directories, websites)

2. **Sender Identification**:
   ```
   From: TradeLine 24/7 <info@tradeline247ai.com>
   Body Footer:
   ---
   Apex Business Systems
   Edmonton, AB, Canada
   info@tradeline247ai.com
   ```

3. **Working Unsubscribe Mechanism**:
   - Headers: `List-Unsubscribe` + `List-Unsubscribe-Post: One-Click`
   - Footer link: "Unsubscribe" or "Update preferences"
   - Must be honored within 10 business days (we do instant)
   - No login required, no confirmation page required

### CASL Penalties
- Up to $10M CAD per violation for corporations
- Personal liability for officers/directors who knowingly consent to violations

## PIPEDA (Personal Information Protection)

### ✅ Requirements:

1. **Privacy Policy Link**:
   - Every email must link to privacy policy
   - Policy must explain: what data collected, why, how long retained, how to access/correct

2. **Purpose Statement**:
   ```
   "You're receiving this because [reason]:
   - You requested information about our services
   - You have an existing business relationship with us
   - Your contact information is publicly available"
   ```

3. **Respect Opt-Out**:
   - Immediately suppress unsubscribed emails
   - `unsubscribes` table is source of truth
   - `v_sendable_members` view auto-filters

### PIPEDA Data Retention
- Keep only what's necessary
- Delete or anonymize after business purpose fulfilled
- Maximum 24 months for implied consent (EBR)

## Mailbox Provider Requirements

### ✅ SPF/DKIM/DMARC Setup

**Current Status Check:**
```bash
# SPF Check
dig TXT tradeline247ai.com | grep spf

# DKIM Check
dig TXT default._domainkey.tradeline247ai.com

# DMARC Check
dig TXT _dmarc.tradeline247ai.com
```

**Required DNS Records:**

1. **SPF (Sender Policy Framework)**:
   ```
   TXT @ "v=spf1 include:_spf.resend.com ~all"
   ```

2. **DKIM (DomainKeys Identified Mail)**:
   - Generated by Resend, add provided TXT records
   - Format: `default._domainkey.tradeline247ai.com`

3. **DMARC (Domain-based Message Authentication)**:
   ```
   TXT _dmarc "v=DMARC1; p=quarantine; rua=mailto:dmarc@tradeline247ai.com; ruf=mailto:dmarc@tradeline247ai.com; fo=1"
   ```
   - **Minimum**: `p=quarantine`
   - **Production goal**: `p=reject` (after monitoring)

### Gmail/Yahoo Requirements (2024+)

**Bulk Sender Thresholds:**
- 5,000+ emails/day to Gmail
- Any commercial email to Yahoo

**Must Have:**
- ✅ SPF/DKIM aligned and passing
- ✅ DMARC at `p=quarantine` minimum
- ✅ One-click unsubscribe (List-Unsubscribe-Post)
- ✅ Spam complaint rate < 0.3%
- ✅ Valid reverse DNS (PTR record)

**Test Email Headers:**
```
Authentication-Results: mx.google.com;
  dkim=pass header.i=@tradeline247ai.com;
  spf=pass smtp.mailfrom=info@tradeline247ai.com;
  dmarc=pass (p=QUARANTINE sp=QUARANTINE dis=NONE) header.from=tradeline247ai.com
```

### Monitoring

**Resend Dashboard:**
- https://resend.com/emails
- Monitor: deliveries, bounces, complaints, opens

**Google Postmaster Tools:**
- https://postmaster.google.com
- Add domain: tradeline247ai.com
- Monitor: IP reputation, domain reputation, spam rate

**Setup Required:**
1. Add DNS TXT record for domain verification (from Postmaster Tools)
2. Wait 24-48 hours for data to appear
3. Target metrics:
   - Spam rate: < 0.1% (max 0.3%)
   - Domain reputation: High
   - IP reputation: High

## Pre-Send Checklist

Before sending any campaign:

- [ ] All recipients have valid consent basis
- [ ] Unsubscribes filtered (via `v_sendable_members`)
- [ ] Email includes sender identification
- [ ] Email includes purpose/reason for contact
- [ ] Unsubscribe headers present (List-Unsubscribe)
- [ ] Footer unsubscribe link works
- [ ] Privacy policy linked
- [ ] SPF/DKIM/DMARC passing
- [ ] Test send to Gmail shows "Unsubscribe" button
- [ ] Dry run with `dry_run: true` parameter

## Testing Commands

### Test Campaign Creation
```bash
curl -X POST \
  "https://hysvqdwmhxnblxfqnszn.supabase.co/functions/v1/ops-campaigns-create" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "organization_id": "YOUR_ORG_ID",
    "name": "Test Campaign",
    "subject": "Quick update from TradeLine 24/7",
    "body_template": "<p>Hello,</p><p>Quick update...</p><p><a href=\"{unsubscribe_url}\">Unsubscribe</a></p>",
    "consent_basis_filter": ["express", "implied_ebr"]
  }'
```

### Test Dry Run Send
```bash
curl -X POST \
  "https://hysvqdwmhxnblxfqnszn.supabase.co/functions/v1/ops-campaigns-send" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "campaign_id": "CAMPAIGN_ID",
    "batch_size": 10,
    "dry_run": true
  }'
```

### Test Real Send (10 contacts)
```bash
curl -X POST \
  "https://hysvqdwmhxnblxfqnszn.supabase.co/functions/v1/ops-campaigns-send" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "campaign_id": "CAMPAIGN_ID",
    "batch_size": 10,
    "dry_run": false
  }'
```

## Compliance Monitoring

### Weekly Review:
```sql
-- Unsubscribe rate
SELECT
  COUNT(*) as unsubscribes_last_7d,
  COUNT(*) * 100.0 / (SELECT COUNT(*) FROM campaign_members WHERE sent_at > NOW() - INTERVAL '7 days') as unsubscribe_rate
FROM unsubscribes
WHERE unsubscribed_at > NOW() - INTERVAL '7 days';

-- Consent basis distribution
SELECT
  consent_basis,
  COUNT(*) as count,
  COUNT(*) * 100.0 / SUM(COUNT(*)) OVER () as percentage
FROM campaign_members
WHERE created_at > NOW() - INTERVAL '30 days'
GROUP BY consent_basis;

-- Bounces/failures (check Resend dashboard)
SELECT
  DATE(sent_at) as date,
  COUNT(*) as sent,
  COUNT(CASE WHEN status = 'bounced' THEN 1 END) as bounced
FROM campaign_members
WHERE sent_at > NOW() - INTERVAL '7 days'
GROUP BY DATE(sent_at);
```

## Emergency Stop

If spam complaints exceed 0.3% or issues detected:

1. **Pause all campaigns:**
   ```sql
   UPDATE campaigns
   SET status = 'paused'
   WHERE status = 'running';
   ```

2. **Review recent sends:**
   ```sql
   SELECT * FROM campaign_members
   WHERE sent_at > NOW() - INTERVAL '24 hours'
   ORDER BY sent_at DESC;
   ```

3. **Check unsubscribes:**
   ```sql
   SELECT * FROM unsubscribes
   WHERE unsubscribed_at > NOW() - INTERVAL '24 hours'
   ORDER BY unsubscribed_at DESC;
   ```

4. **Contact support:**
   - Resend: support@resend.com
   - Review deliverability metrics
   - Implement corrective action before resuming
